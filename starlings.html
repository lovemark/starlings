<!-- Starlings game -->
<html>
  <head>
    <title>Starlings - The Game</title>
    <script type="text/javascript" src="http://luismark.github.io/apis/luismark/v1.1.0/luismark.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.2.js"></script>
    <script type="text/javascript" src="http://snap.berkeley.edu/snapsource/morphic.js"></script>
  </head>
  <body>
    <canvas class="world" id="mainCanvas" width="50" height="40"></canvas>
    <script type="text/javascript">
      var starlingsTimer = setInterval(function() {
        // Only execute in full screen
        if (Math.max($(document).height(), $(window).height()) >= screen.availHeight) {
          clearInterval(starlingsTimer);
          var starlingsManager = new StarlingsManagerMorph(),
              world = new WorldMorph($(".world")[0]);
          starlingsManager.openIn(world);
          var gameTimer = setInterval(function() {
            world.doOneCycle();
          }, 1);
          starlingsManager.onError(function(self) {
            self.errorMsg = new ErrorMessageMorph(self);
            self.addChild(self.errorMsg);
          });
        }
      }, 500);
      function StarlingsManagerMorph() {
        this.init();
      }
      StarlingsManagerMorph.prototype = new FrameMorph();
      StarlingsManagerMorph.prototype.constructor = StarlingsManagerMorph;
      StarlingsManagerMorph.uber = FrameMorph.prototype;
      StarlingsManagerMorph.prototype.init = function() {
        StarlingsManagerMorph.uber.init.call(this);
        this.username = "";
        this.planets = [];
        this.currentPlanetIndex = 0;
        this.morph = null;
        this.bounds = new Rectangle(0, 0, 1366, 768);
        this.colour = this.color = new Color();
        this.coins = 0;
        this.minerals = 0;
        this.errorCallback = function() { return true; };
        this.starlings = [];
        this.header = new StarlingsHeaderMorph(this);
        this.addChild(this.header);
        this.mode = 1; // 1 for galaxy, 2 for planet, 3 for system
        this.starlingTimeout = 10000;
      };
      jQuery.each(["Coins", "Minerals"], function(i, e) {
        StarlingsManagerMorph.prototype["add" + e] = function(amount) {
          this[e.toLowerCase()] += amount;
          if (this.planets[this.currentPlanetIndex].allStorage(e) < this[e.toLowerCase()]) {
            this[e.toLowerCase()] = this.planets[this.currentPlanetIndex].allStorage(e);
            console.log("Insufficient storage for " + e.toLowerCase());
            return false;
          }
          return true;
        };
        StarlingsManagerMorph.prototype["remove" + e] = function(amount) {
          this[e.toLowerCase()] -= amount;
          if (this[e.toLowerCase()] < 0) {
            this[e.toLowerCase()] = 0;
            console.log("We don't have enough " + e.toLowerCase() + "!");
            return false;
          }
          return true;
        };
      });
      // Use a recursive Math.max to support more than 2 arguments
      // to behave like the native code version but as a
      // JavaScript-defined method.
      Math.max = function(a) {
        if (arguments.length === 1) {
          return a;
        }
        var b = Math.max.apply(Math, Array.prototype.slice.call(arguments).slice(1, arguments.length));
        return a > b ? a : b;
      };
      StarlingsManagerMorph.prototype.openIn = function(world) {
        this.bounds = world.bounds;
        this.world = world;
        if (!contains(world.children, this)) {
          world.addChild(this);
        }
      };
      StarlingsManagerMorph.prototype.onError = function(callback) {
        this.errorCallback = jQuery.isFunction(callback) ? callback : this.callback;
      };
      StarlingsManagerMorph.prototype.step = function() {
        /* Notes:
         * This method is executed every 1 ms.
         * This is the game stepper itself.
         * The timer is only triggered in full screen.
         */
        if (this.mode !== 2) {
          this.starlings = [];
        } else {
          this.starlingTimeout -= 1;
          if (this.starlingTimeout <= 0) {
            this.starlings.forEach(function(starling) {
              starling.end();
            });
            this.starlings = [];
            this.starlingTimeout = 10000;
            this.generateStarlings(0, 0, 3072, 3072, 112);
          }
        }
        this.parent.fullDrawOn(this.parent.worldCanvas);
        this.starlings.forEach(function(starling) {
          var stepper = starling && starling.step;
          if (starling instanceof Morph
          &&  stepper !== Morph.prototype.step
          &&  jQuery.isFunction(step)
          &&  stepper.toString().replace("  ", " ")
          !=  Morph.prototype.toString.replace("  ", " ")) {
            // Step if this is a morph and it has a stepper different
            // from Jens' default stepper for morphs.
            starling.step();
          }
        });
      };
      StarlingsManagerMorph.prototype.generateStarlings = function(x, y, w, h, n) {
        for (var i = 0; i < n; i++) {
          new StarlingMorph(this, 10 + x + (Math.random() * (w - 20)), 10 + y + (Math.random() * (h - 20)));
        }
      };
      function StarlingsHeaderMorph(manager) {
        this.init(manager);
      }
      StarlingsHeaderMorph.prototype = new Morph();
      StarlingsHeaderMorph.prototype.constructor = StarlingsHeaderMorph;
      StarlingsHeaderMorph.uber = Morph.prototype;
      StarlingsHeaderMorph.prototype.init = function(manager) {
        StarlingsHeaderMorph.uber.init.call(this);
        this.texture = "http://luismark.github.io/starlings/assets/header.png";
        this.bounds = new Rectangle(0, 0, 450, 160);
        manager.addChild(this);
        this.drawNew();
      };
      modules.starlings = "2014-December-21";
      function StarlingMorph(manager, x, y) {
        this.init(manager, x, y);
      }
      StarlingMorph.prototype = new Morph();
      StarlingMorph.prototype.constructor = StarlingMorph;
      StarlingMorph.uber = Morph.prototype;
      StarlingMorph.prototype.init = function(manager, x, y) {
        StarlingMorph.uber.init.call(this);
        this.starlingX = x;
        this.starlingY = y;
        this.starlingBounds = new Rectangle(x, y, 20, 20);
        manager.starlings.push(this);
      };
      StarlingMorph.prototype.end = function(manager) {
        var index = manager.starlings.indexOf(this);
        var array = manager.starlings;
        if (index != -1) {
          // Get rid of this Starling in the Starling table of the manager.
          manager.starlings = array.slice(0, index).concat(array.slice(index + 1, array.length));
        }
      };
    </script>
  </body>
</html>